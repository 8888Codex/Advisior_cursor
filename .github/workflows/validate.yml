name: Valida√ß√£o de C√≥digo

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validar Mudan√ßas
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Instalar depend√™ncias Node.js
        run: npm ci
      
      - name: Instalar depend√™ncias Python
        run: |
          cd python_backend
          pip install -r requirements.txt
      
      # ============================================================
      # VALIDA√á√ÉO 1: TypeScript Type Checking
      # ============================================================
      - name: ‚úÖ TypeScript Type Check
        run: npm run check
        continue-on-error: false
      
      # ============================================================
      # VALIDA√á√ÉO 2: Python Imports
      # ============================================================
      - name: ‚úÖ Validar Imports Python
        run: python scripts/check-imports.py
        continue-on-error: true  # Warnings n√£o bloqueiam
      
      # ============================================================
      # VALIDA√á√ÉO 3: Endpoint Compatibility
      # ============================================================
      - name: ‚úÖ Validar Compatibilidade de Endpoints
        run: python scripts/check-endpoints.py
        continue-on-error: true  # Warnings n√£o bloqueiam
      
      # ============================================================
      # VALIDA√á√ÉO 4: Linting (Futuro)
      # ============================================================
      # - name: ‚úÖ ESLint (Frontend)
      #   run: npm run lint
      #   continue-on-error: true
      
      # - name: ‚úÖ Flake8 (Python)
      #   run: |
      #     pip install flake8
      #     flake8 python_backend/
      #   continue-on-error: true
      
      # ============================================================
      # VALIDA√á√ÉO 5: Testes (Futuro)
      # ============================================================
      # - name: ‚úÖ Testes Frontend
      #   run: npm test
      
      # - name: ‚úÖ Testes Backend
      #   run: pytest python_backend/tests/
      
      # ============================================================
      # COMENT√ÅRIO AUTOM√ÅTICO (Opcional)
      # ============================================================
      - name: üí¨ Comentar Resultados
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## üõ°Ô∏è Valida√ß√£o Autom√°tica
            
            **Status:** ${{ job.status }}
            
            ### Valida√ß√µes Executadas:
            - ‚úÖ TypeScript Type Check
            - ‚úÖ Python Imports
            - ‚úÖ Endpoint Compatibility
            
            ### Pr√≥ximos Passos:
            1. Verifique se TODAS as valida√ß√µes passaram
            2. Complete o checklist do template de PR
            3. Aguarde aprova√ß√£o do revisor
            
            **Lembrete:** Consulte [PROCESSO_VALIDACAO.md](PROCESSO_VALIDACAO.md) antes de modificar c√≥digo!
            `;
            
            // Comentar apenas em PRs
            if (context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # ============================================================
  # JOB 2: Build Test (Verificar se builda)
  # ============================================================
  build-test:
    name: Testar Build
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Instalar depend√™ncias
        run: npm ci
      
      - name: üèóÔ∏è Build Frontend
        run: npm run build
        continue-on-error: false
      
      - name: ‚úÖ Build Sucesso
        run: echo "Build passou com sucesso!"

  # ============================================================
  # JOB 3: Security Check (Futuro)
  # ============================================================
  # security:
  #   name: Security Scan
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: üîí npm audit
  #       run: npm audit --audit-level=high
  #       continue-on-error: true
  #     
  #     - name: üîí Python safety check
  #       run: |
  #         pip install safety
  #         safety check
  #       continue-on-error: true
